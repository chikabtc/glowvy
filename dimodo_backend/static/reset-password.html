<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Document</title>
    <!--                    Link                    -->
    <link href="./assets/css/mrsong.css" rel="stylesheet">
    <link href="./assets/css/custom.css" rel="stylesheet">

    <!--                    Link Add                -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
    <link href="https://fonts.googleapis.com/css?family=Be+Vietnam:500,700&display=swap" rel="stylesheet">
</head>

<body class="view_width_100 view_height_100 flex_center">

    <div id="show_form" style="width: 300px;">
        <div class="text_center">

            <img class="rounded_circle square_7" src="./assets/icons/icon-152x152.png" alt="">
            <div class="text_bold padding_y_2">Đặt Lại Mật Khẩu</div>
        </div>
        <form id="form">
            <div class="text_2 text_bold padding_y_2">Mật Khẩu Mới</div>
            <div class="border rounded padding_2">
                <input id="password" class="border_0 width_x100" type="password" name="password" autocomplete="off">
            </div>
            <div class="text_2 text_bold padding_y_2 margin_top_2">Mật Khẩu Mới ( Nhập Lại )</div>
            <div class="border rounded padding_2">
                <input id="password_confirm" class="border_0 width_x100" type="password" name="password_confirm"
                    autocomplete="off">
            </div>
            <div class="margin_top_4">
                <button type="submit" class="width_x100 padding_y_2 border_0 rounded  background_brand 
                text_bolder text_white text_4">
                    Đổi Mật Khẩu
                </button>
            </div>
        </form>
    </div>
    <div id="show_error" style="width: 300px;">
        <div class="border rounded">
            <div class="background_danger padding_2 ">
                <i class="fa fa-warning text_white" aria-hidden="true"></i>
                <span class="text_white">Đã có lỗi xảy ra.</span>
            </div>
            <div id="error" class="padding_x_2 padding_y_3">
            </div>
        </div>
        <div class="display_flex content_end padding_y_2">
            <a class="text_black text_2" href="/">
                <span id="domain"></span>
                <span>&#8594;</span></a>
        </div>
    </div>
    <script>

        setHostName('domain')
        function setHostName(id) {
            console.log(window.location.hostname)
            let domain = window.location.hostname
            document.getElementById(id).innerHTML = domain
        }
        form.addEventListener('submit', submit);
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        show_main()
        function show_main() {
            error = document.getElementById('error')
            if (!token) {
                show("error")
                error.innerHTML = "- Token không tồn tại."
            } else {
                let payload = GetPayLoadJWT(token)
                let TimeNow = new Date().getTime();
                console.log(TimeNow)
                if (payload == "Error") {
                    show("error")
                    error.innerHTML = "- Token không hợp lệ."
                } else if (payload["exp"] * 1000 < TimeNow) {
                    show("error")
                    error.innerHTML = "- Token đã hết hạn."
                } else {
                    show("form")
                }
            }
        }
        function show(show) {
            const show_error = document.getElementById('show_error')
            const show_form = document.getElementById('show_form')
            if (show == "error") {
                show_form.style.display = 'none'
                show_error.style.display = 'block'
            } else if (show == "form") {
                show_form.style.display = 'block'
                show_error.style.display = 'none'
            }
        }

        function GetPayLoadJWT(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return "Error";
            }
        }
        function submit(event) {
            event.preventDefault()
            password = document.getElementById('password').value
            password_confirm = document.getElementById('password_confirm').value
            if (password != password_confirm) {
                alert("Mật khẩu và mật khẩu nhập lại không giống nhau.")
            } else if (password.length < 4) {
                alert("Độ dài mật khẩu không hợp lệ.")
            } else {
                const new_password = {
                    new: password,
                    confirm_new: password_confirm
                };
                const options = {
                    method: 'POST',
                    body: JSON.stringify(new_password),
                    headers: {
                        'Content-Type': 'application/json',
                        'TokenResetPassword': token
                    }
                }
                fetch("/api/password/reset", options)
                    .then(res => res.json())
                    .then(res => {
                        console.log(res)
                        if (res["Success"] == true) {   
                            alert("Bây giờ bạn đã có thể đăng nhập với mật khẩu mới.")
                            window.location.href = '/'
                        } else {
                            alert("Token không hợp lệ.")
                        }
                    })
                    .catch(err => {
                        console.error('Error: ', err);
                    });
            }
        }
    </script>
</body>

</html>